<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LIST | SO:EUM</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <link rel="stylesheet" href="/static/css/post.css">
    <script src="https://kit.fontawesome.com/2adf3c10c8.js" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

    <script>

        $(document).ready(function () {
            show_post();
        });


        window.onload = function () {

            function onClick() {
                document.querySelector('.modal_wrap').style.display = 'block';
                document.querySelector('.black_bg').style.display = 'block';
            }

            function offClick() {
                document.querySelector('.modal_wrap').style.display = 'none';
                document.querySelector('.black_bg').style.display = 'none';
            }

            document.getElementById('modal_btn').addEventListener('click', onClick);
            document.querySelector('.modal_close').addEventListener('click', offClick);

        };


        function post() {
            let keyword = $("#input_keyword").val()
            let url = $("#input_url").val()
            $.ajax({
                type: "POST",
                url: "/post",
                data: {
                    keyword_give: keyword,
                    url_give: url
                },
                success: function (response) {
                    window.location.reload()
                }
            })
        }


        function show_post() {
            $('#post-list').empty()
            $.ajax({
                type: "GET",
                url: "/post/posting",
                data: {},
                success: function (response) {
                    let rows = response['posts']

                    for (let i = 0; i < rows.length; i++) {
                        let post = rows[i]
                        let num = rows[i]['num']
                        let keyword = rows[i]['keyword']
                        let username = rows[i]['username']
                        let url = rows[i]['url']
                        code = (url.substr(32, 11));
                        var myArray = [code, '/default.jpg'];
                        var myString = 'https://i1.ytimg.com/vi/';
                        for (var m in myArray) {
                            myString = myString.concat(myArray[m]);
                        }


                        let class_heart = post['heart_by_me'] ? "fa-heart": "fa-heart-o"
                        let temp_html = `<div class="post_asmr" id="post-list">
                                            <img class="thumbnail" src="${myString}" onClick="javascript:;window.open('${url}');"'>
                                            <ul class="info" id="${num}">
                                                <li class="info_num">${num} 번째 SO:EUM!</li>
                                                <li>키워드 : ${keyword}</li>
                                                <li>작성자 : ${username}</li>
                                                <span class="like" onclick="toggle_like('${num}')"><i class="fa ${class_heart}" id="heart"></i></span>
                                                <span class="like-num">${post["count_heart"]}</span>
                                            </ul>
                                        </div>`
                        $('#post-list').append(temp_html)
                    }
                },
            });
        }


        //좋아요
        function toggle_like(num) {
            let $a_like = $(`#${num}`)
            let $i_like = $a_like.find("i")

            if ($i_like.hasClass("fa fa-heart")) {
                $.ajax({
                    type: "POST",
                    url: "/post/like",
                    data: {
                        num_give: num,
                        action_give: "unlike"
                    },
                    success: function (response) {
                        $i_like.addClass("fa-heart-o").removeClass("fa-heart")
                        $a_like.find('span.like-num').text(response["count"])
                    }
                })
            } else {
                $.ajax({
                    type: "POST",
                    url: "/post/like",
                    data: {
                        num_give: num,
                        action_give: "like"
                    },
                    success: function (response) {
                        $i_like.addClass("fa-heart").removeClass("fa-heart-o")
                        $a_like.find('span.like-num').text(response["count"])
                    }
                })
            }
        }

        //keyword 누르면 해당 keyword만 분류하여 나오게 하기
        $(document).ready(function () {
            $("#changeTest").change(function () {
                let selected_keyword = $(this).val();
                $("#changeInput").val($(this).val());

                $('#post-list').empty()
                $.ajax({
                    type: "GET",
                    url: "/post/posting",
                    data: {},
                    success: function (response) {
                        let rows = response['posts']
                        for (let i = 0; i < rows.length; i++) {
                            let keywords = rows[i]['keyword']
                            let post = rows[i]
                            let num = rows[i]['num']
                            let username = rows[i]['username']
                            let url = rows[i]['url']
                            code = (url.substr(32, 11));
                            var myArray = [code, '/default.jpg'];
                            var myString = 'https://i1.ytimg.com/vi/';
                            for (var m in myArray) {
                                myString = myString.concat(myArray[m]);
                            }
                            if ($.trim(keywords) == selected_keyword) {
                                let class_heart = post['heart_by_me'] ? "fa-heart" : "fa-heart-o"
                                let temp_html = `<div class="post_asmr" id="post-list">
                                            <img class="thumbnail" src="${myString}" onClick="javascript:;window.open('${url}');"'>
                                            <ul class="info" id="${num}">
                                                <li class="info_num">${num} 번째 SO:EUM!</li>
                                                <li>키워드 : ${keywords}</li>
                                                <li>작성자 : ${username}</li>
                                                <span class="like" onclick="toggle_like('${num}')"><i class="fa ${class_heart}" id="heart"></i></span>
                                                <span class="like-num">${post["count_heart"]}</span>
                                            </ul>
                                        </div>`
                                $('#post-list').append(temp_html)
                            } else if (selected_keyword == "전체") {
                                window.location.href = '/post';
                        }
                    }
                }
            })

        });
        })
        ;


    </script>


</head>
<body>

{% include "header.html"%}


<div class="top">
    <div class="insert_btn">

        <div id="modal_btn" class="modal_btn">당신의 ASMR을 등록해보세요.</div>
        <div class="black_bg"></div>
        <div class="modal_wrap">
            <div class="modal_close">
                <a href="#">close</a>
            </div>
            <div>
                <select class="modal_keyword" id="input_keyword">
                    <option value="">키워드를 골라주세요!</option>
                    <option value="슬라임">슬라임</option>
                    <option value="음식">음식</option>
                    <option value="사물">사물</option>
                    <option value="자연">자연</option>
                    <option value="수다">수다</option>
                </select>
            </div>

            <div>
                <input type="url" class="modal_url" id="input_url" placeholder="URL을 입력해주세요!">
            </div>
            <button class="modal_submit" onclick="post()">당신의 ASMR을 등록해보세요.</button>
        </div>
    </div>
</div>


<div class="mid">
    <div class="keyword_wrap" id="changeInput">
        <div class="keytext"># Keyword</div>
        <select name="keyword" id="changeTest">
            <option value="전체">전체</option>
            <option value="슬라임">슬라임</option>
            <option value="음식">음식</option>
            <option value="사물">사물</option>
            <option value="자연">자연</option>
            <option value="수다">수다</option>
        </select>
    </div>

    <div class="post_zone">
        <div id="post-list">
        </div>
    </div>

    <div class="top5">
        <span>❤️ TOP 5</span>
        <ul>
            <li>1. 좋아요 1위</li>
            <li>2. 좋아요 2위</li>
            <li>3. 좋아요 3위</li>
            <li>4. 좋아요 4위</li>
            <li>5. 좋아요 5위</li>
        </ul>
    </div>
</div>


</body>
</html>